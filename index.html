<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Fitness Coach Pro</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
</head>
<body>

    <h1>
        <select id="exercise-select" onchange="resetCounter()">
            <option value="squat">ğŸ‹ï¸ Squat</option>
            <option value="curl">ğŸ’ª Bicep Curl</option>
        </select>
    </h1>

    <div class="container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="output"></canvas>
        
        <div id="ui-layer">
            <div id="rep-counter" class="hud-stat">0 Reps</div>
            <div id="ai-feedback" class="hud-stat">Ready to train</div>
        </div>
    </div>

    <div class="controls">
        <button onclick="checkFormWithAI()">ğŸ” Check Form</button>
        <button class="danger" onclick="finishWorkout()">ğŸ Finish</button>
    </div>

    <canvas id="snapshot" style="display:none;"></canvas>

<script>
    let detector, camera, ctx;
    let repCount = 0;
    let state = "up"; // "up" or "down"
    let isAnalyzing = false;
    
    // Voice Synthesis Setup
    const synth = window.speechSynthesis;

    async function init() {
        // 1. Setup AI
        const detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING };
        detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);
        
        // 2. Setup Camera (Mobile Optimized)
        camera = document.getElementById('video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { facingMode: 'user', frameRate: { ideal: 60 } }
            });
            camera.srcObject = stream;
            
            camera.onloadedmetadata = () => {
                resizeCanvas();
                detectPose();
            };
            window.addEventListener('resize', resizeCanvas);
            
        } catch (err) {
            document.getElementById('ai-feedback').innerText = "Cam Error: " + err.message;
        }
    }

    async function detectPose() {
        const poses = await detector.estimatePoses(camera);
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        if (poses.length > 0) {
            const kp = poses[0].keypoints;
            drawSkeleton(kp, ctx);
            
            const exerciseType = document.getElementById('exercise-select').value;

            if (exerciseType === 'squat') {
                processSquat(kp);
            } else {
                processCurl(kp);
            }
        }
        requestAnimationFrame(detectPose);
    }

    // --- Exercise Logic: SQUAT ---
    function processSquat(kp) {
        // Hip(11), Knee(13), Ankle(15)
        if(kp[11].score > 0.4 && kp[13].score > 0.4 && kp[15].score > 0.4) {
            const angle = calculateAngle(kp[11], kp[13], kp[15]);
            if (angle < 90 && state === "up") state = "down";
            if (angle > 160 && state === "down") {
                state = "up";
                incrementRep();
            }
        }
    }

    // --- Exercise Logic: CURL ---
    function processCurl(kp) {
        // Shoulder(5), Elbow(7), Wrist(9)
        if(kp[5].score > 0.4 && kp[7].score > 0.4 && kp[9].score > 0.4) {
            const angle = calculateAngle(kp[5], kp[7], kp[9]);
            if (angle > 160) state = "down"; // Arm straight
            if (angle < 50 && state === "down") { // Arm curled
                state = "up";
                incrementRep();
            }
        }
    }

    function incrementRep() {
        repCount++;
        document.getElementById('rep-counter').innerText = `${repCount} Reps`;
        if(repCount % 5 === 0) checkFormWithAI(); // Auto-check every 5
    }

    function resetCounter() {
        repCount = 0;
        document.getElementById('rep-counter').innerText = "0 Reps";
        state = "up";
    }

    // --- UPDATED: AI Check with DEBUGGING ---
    window.checkFormWithAI = async function() {
        if (isAnalyzing) return;
        isAnalyzing = true;

        const feedbackEl = document.getElementById('ai-feedback');
        feedbackEl.innerText = "ğŸ¤– Analyzing...";
        feedbackEl.style.color = "#FFD700";

        const snapCanvas = document.getElementById('snapshot');
        snapCanvas.width = camera.videoWidth;
        snapCanvas.height = camera.videoHeight;
        snapCanvas.getContext('2d').drawImage(camera, 0, 0);
        const base64 = snapCanvas.toDataURL('image/jpeg', 0.5);

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64 })
            });

            // 1. Capture Raw Text first (in case it's not JSON)
            const rawText = await response.text();

            // 2. Try to parse JSON
            let data;
            try {
                data = JSON.parse(rawText);
            } catch (e) {
                // If parsing fails, the server sent an HTML error (like 404 or 504)
                throw new Error(`Server Error: ${rawText.substring(0, 50)}...`);
            }

            // 3. Handle API Errors
            if (!response.ok || data.error) {
                const errorMsg = data.error || rawText;
                throw new Error(errorMsg);
            }

            // 4. Success!
            const advice = data.advice;
            feedbackEl.innerText = `ğŸ’¡ ${advice}`;
            feedbackEl.style.color = "#00ff88";
            speak(advice);

        } catch (err) {
            // DEBUG MODE: Show the specific error on screen
            console.error(err);
            feedbackEl.innerText = `âŒ Error: ${err.message}`;
            feedbackEl.style.color = "red";
            speak("Connection error. Check screen.");
        }

        isAnalyzing = false;
    }

    // --- Voice Feedback Helper ---
    function speak(text) {
        if (synth.speaking) synth.cancel(); // Stop previous speech
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 1.0;
        synth.speak(utterance);
    }

    // --- Helpers ---
    function calculateAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return angle;
    }

    function drawSkeleton(keypoints, ctx) {
        keypoints.forEach(p => {
            if(p.score > 0.4) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, 2*Math.PI);
                ctx.fillStyle = 'red';
                ctx.fill();
            }
        });
    }

    function resizeCanvas() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('output');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx = canvas.getContext('2d');
    }

    window.finishWorkout = function() {
        localStorage.setItem('totalReps', repCount);
        window.location.href = 'result.html';
    }

    init();
</script>
</body>
</html>