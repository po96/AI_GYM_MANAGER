<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Fitness Coach - Timer Edition</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <style>
        /* Huge Counter */
        #rep-counter {
            font-size: 7rem !important; 
            top: 60px; /* Moved down slightly to fit timer */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            background: transparent;
            text-shadow: 2px 2px 4px #000;
        }
        
        /* New Timer Style */
        #timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
            z-index: 20;
        }

        #debug-angle {
            font-size: 1.2rem;
            background: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

	<h1>
		<select id="exercise-select" onchange="updateInstruction()">
			<option value="squat">üèãÔ∏è Squat</option>
			<option value="curl">üí™ Bicep Curl</option>
		</select>
	</h1>

	<p id="instruction-text" style="
		text-align: center; 
		color: #aaa; 
		margin-top: -10px; 
		font-size: 1rem;
		font-style: italic;">
		‚ÑπÔ∏è Stand sideways to camera
	</p>

    <div class="container">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="output"></canvas>
        
        <div id="ui-layer">
            <div id="timer-display">00:00</div>

            <div id="rep-counter" class="hud-stat">0</div>
            
            <div id="debug-angle" class="hud-stat" style="top: 150px; right: 10px; color: yellow;">Stand Up</div>
            
            <div id="ai-feedback" class="hud-stat">Ready</div>
        </div>
    </div>

    <div class="controls">
        <button onclick="checkFormWithAI()">üîç Check Form</button>
        <button class="danger" onclick="finishWorkout()">üèÅ Finish</button>
    </div>

    <canvas id="snapshot" style="display:none;"></canvas>

<script>
    let detector, camera, ctx;
    let totalReps = 0;
    let perfectReps = 0;
    
    // Squat State
    let squatState = "standing";
    let maxDepthAngle = 0;
    
    let isAnalyzing = false;
    const synth = window.speechSynthesis;

    // Timer Variables
    let startTime;
    let timerInterval;

    async function init() {
        // Start Timer immediately
        startTimer();

        const detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING };
        detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);
        
        camera = document.getElementById('video');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { facingMode: 'user', frameRate: { ideal: 60 } }
            });
            camera.srcObject = stream;
            camera.onloadedmetadata = () => {
                resizeCanvas();
                detectPose();
            };
            window.addEventListener('resize', resizeCanvas);
        } catch (err) {
            alert(err.message);
        }
    }

    // --- TIMER LOGIC ---
    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            // Format as 00:00
            document.getElementById('timer-display').innerText = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    async function detectPose() {
        const poses = await detector.estimatePoses(camera);
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        if (poses.length > 0) {
            const kp = poses[0].keypoints;
            drawSkeleton(kp, ctx);
            
            const exerciseType = document.getElementById('exercise-select').value;
            if (exerciseType === 'squat') {
                processSquatThighs(kp);
            } else {
                processCurl(kp);
            }
        }
        requestAnimationFrame(detectPose);
    }

    function processSquatThighs(kp) {
        const hip = kp[11];
        const knee = kp[13];

        if(hip.score > 0.3 && knee.score > 0.3) {
            const currentAngle = calculateSegmentAngle(hip, knee);
            const debugEl = document.getElementById('debug-angle');
            debugEl.innerText = `Depth: ${Math.floor(currentAngle)}¬∞`;

            if (currentAngle > 30) {
                if (currentAngle > maxDepthAngle) maxDepthAngle = currentAngle;
            }

            // Descending
            if (currentAngle > 35 && squatState === "standing") {
                squatState = "descending";
                debugEl.style.color = "yellow";
            }

            // Ascending (Finishing Rep)
            if (currentAngle < 20 && squatState === "descending") {
                
                // 1. ALWAYS Count the rep (Motivation!)
                totalReps++; 
                
                // 2. CHECK QUALITY
                // Changed from 75 to 60 for easier Perfect Score
                if (maxDepthAngle > 60) {
                    perfectReps++;
                    debugEl.innerText = "‚ú® PERFECT!";
                    debugEl.style.color = "#00ff88"; 
                } else {
                    debugEl.innerText = "‚ö†Ô∏è TRY DEEPER";
                    debugEl.style.color = "orange";
                    // Only trigger AI on bad reps to save API calls
                    checkFormWithAI(); 
                }

                updateCounter();
                squatState = "standing";
                maxDepthAngle = 0;
            }
        }
    }

    function calculateSegmentAngle(a, b) {
        const dy = b.y - a.y; 
        const dx = b.x - a.x; 
        const radians = Math.atan2(Math.abs(dy), Math.abs(dx));
        const degrees = radians * (180/Math.PI);
        return 90 - degrees;
    }

    function updateCounter() {
        document.getElementById('rep-counter').innerText = totalReps;
    }

	function updateInstruction() {
		resetCounter(); // Keep your existing reset
		
		const exercise = document.getElementById('exercise-select').value;
		const textEl = document.getElementById('instruction-text');

		if (exercise === 'squat') {
			textEl.innerText = "‚ÑπÔ∏è ÏòÜÏúºÎ°ú ÏÑúÏÑú ÏûêÏÑ∏Î•º Ï∑®ÌïòÎ©¥ Îçî Ï†ïÌôïÌïú Ï∏°Ï†ïÏùÑ Ìï† Ïàò ÏûàÏñ¥Ïöî";
		} else {
			textEl.innerText = "‚ÑπÔ∏è Ï†ïÎ©¥ÏúºÎ°ú ÏÑúÍ±∞ÎÇò ÏòÜÏúºÎ°ú ÏÑúÏÑ∏Ïöî";
		}
	}
    // --- AI & API ---
    window.checkFormWithAI = async function() {
        if (isAnalyzing) return;
        isAnalyzing = true;
        const feedbackEl = document.getElementById('ai-feedback');
        feedbackEl.innerText = "üëÄ Í≥ÑÏÜçÌïòÏÑ∏Ïöî!";
        
        const snapCanvas = document.getElementById('snapshot');
        snapCanvas.width = camera.videoWidth;
        snapCanvas.height = camera.videoHeight;
        snapCanvas.getContext('2d').drawImage(camera, 0, 0);
        const base64 = snapCanvas.toDataURL('image/jpeg', 0.5);

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64 })
            });
            const data = await response.json();
            if (data.advice) {
                feedbackEl.innerText = data.advice;
                speak(data.advice);
            }
        } catch (err) {
            console.error(err);
        }
        isAnalyzing = false;
    }

    function speak(text) {
        if (synth.speaking) synth.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        synth.speak(utterance);
    }
    
    // Standard Curl Logic (unchanged)
    function processCurl(kp) {
        const shoulder = kp[5]; const elbow = kp[7]; const wrist = kp[9];
        if(shoulder.score > 0.3 && elbow.score > 0.3 && wrist.score > 0.3) {
            const angle = calculateThreePointAngle(shoulder, elbow, wrist);
            if (angle > 160) squatState = "down"; 
            if (angle < 60 && squatState === "down") {
                squatState = "up";
                totalReps++;
                updateCounter();
            }
        }
    }
    function calculateThreePointAngle(a,b,c) {
        const r = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let ang = Math.abs(r * 180.0 / Math.PI);
        if (ang > 180.0) ang = 360 - ang;
        return ang;
    }
    function drawSkeleton(keypoints, ctx) {
        keypoints.forEach(p => {
            if(p.score > 0.3) {
                ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, 2*Math.PI);
                ctx.fillStyle = 'red'; ctx.fill();
            }
        });
    }
    function resizeCanvas() {
        const v = document.getElementById('video');
        const c = document.getElementById('output');
        c.width = v.videoWidth; c.height = v.videoHeight;
        ctx = c.getContext('2d');
    }
    window.resetCounter = function() {
        totalReps = 0; perfectReps = 0;
        document.getElementById('rep-counter').innerText = "0";
        // Reset timer
        clearInterval(timerInterval);
        startTimer();
    }

    // --- FINISH: Save Data ---
    window.finishWorkout = function() {
        localStorage.setItem('totalReps', totalReps);
        localStorage.setItem('perfectReps', perfectReps);
        
        // Save Time
        const timeText = document.getElementById('timer-display').innerText;
        localStorage.setItem('workoutTime', timeText);
        
        window.location.href = 'result.html';
    }

    init();
</script>
</body>
</html>